# This is a sample build configuration for Python.
# Check our guides at https://confluence.atlassian.com/x/x4UWN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: python:3.7

clone:
  depth: full
pipelines:
  branches:
#    tags:                         # add the 'tags' section
#      release-*:                  # specify the tag
#        - step:                   # define the build pipeline for the tag
#          name: Deploy and release
#          deployment: production   # set to test, staging or production
#          script:
#            - git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git HEAD
    master:
      - step:
          # set HEROKU_API_KEY and HEROKU_APP_NAME environment variables
          # set clone `depth: full' as described here: https://confluence.atlassian.com/x/Y9-5Mw
          name: Build release artifacts
          deployment: production
          caches:
            - pip
          script:
            - pip install -r requirements.txt
            - python manage.py test
            # TODO: Uncomment this when I am truly ready to deploy to production
#            - git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git HEAD
    develop:
      - step:
          # set HEROKU_API_KEY and HEROKU_APP_NAME environment variables
          # set clone `depth: full' as described here: https://confluence.atlassian.com/x/Y9-5Mw
          name: Deploy to Stage
          deployment: staging
          caches:
            - pip
          script:
            - pip install -r requirements.txt
            - python manage.py test
            # TODO: Uncomment this when I am truly ready to deploy to stage
#            - git push https://heroku:$HEROKU_STAGE_API_KEY@git.heroku.com/$HEROKU_STAGE_APP_NAME.git HEAD
    feature/*:
      - step:
          deployment: test
          caches:
            - pip
          script:
            - pip install -r requirements.txt
            - apt-get update && apt-get install -y postgresql-client
            - psql -c 'drop database if exists atlas_pipeline_db;' -U postgres
            - psql -c 'create database atlas_pipeline_db;' -U postgres
            - python manage.py migrate
            - python manage.py test
          services:
            - postgres

definitions:
  services:
    postgres:
      image: postgres
      environment:
        POSTGRES_DB: atlas_pipeline_db
        POSTGRES_USER: test_user
        POSTGRES_PASSWORD: test_user_password